---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import ProductDetail from '../../components/ProductDetail';
import { getProductBySkuFromD1 } from '../../lib/d1-products';
import { products as staticProducts } from '../../data/products';

const sku = Astro.params.id;
if (!sku) return Astro.redirect('/produkte');

const db = Astro.locals.runtime?.env?.DB as import('../../lib/d1-products').D1Database | undefined;
let product = db ? await getProductBySkuFromD1(db, sku) : staticProducts.find((p) => p.id === sku) ?? null;
if (!product && db && sku.includes('-')) {
	const baseSku = sku.split('-')[0];
	if (baseSku) product = await getProductBySkuFromD1(db, baseSku);
}
if (!product && !db) product = staticProducts.find((p) => p.id === sku || p.id === sku.split('-')[0]) ?? null;

if (!product) return Astro.redirect('/produkte');
---

<Layout title={`${product.name} - E-Kinderauto Shop`}>
	<Header />
	<main class="container mx-auto px-4 py-8">
		<ProductDetail product={product} client:load />
	</main>
</Layout>

