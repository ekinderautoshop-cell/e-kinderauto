---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import NewsletterModal from '../components/NewsletterModal';
import { categoriesWithImages, getRandomProductImageFromCategory, ALLOWED_CATEGORY_NAMES, getCategoryDisplayName } from '../data/shop-content';
import { products as staticProducts } from '../data/products';
import { getProductsFromD1 } from '../lib/d1-products';
import { isErsatzteilProduct, isZusatzartikelProduct } from '../lib/d1-products';

const db = Astro.locals.runtime?.env?.DB as import('../lib/d1-products').D1Database | undefined;
const allFromDb = db ? await getProductsFromD1(db) : staticProducts;
const allowedSet = new Set(ALLOWED_CATEGORY_NAMES);
const allProducts = allFromDb.filter(
	(p) =>
		p.category &&
		allowedSet.has(p.category) &&
		!isErsatzteilProduct(p.name) &&
		!isZusatzartikelProduct(p.name)
);

/** Pro Kategorie: Bild = zufälliges Produktbild aus der Kategorie, sonst Fallback. */
const categoriesWithBackgroundImages = categoriesWithImages.map((cat) => ({
	...cat,
	image: getRandomProductImageFromCategory(cat.name, allProducts) || cat.image,
}));
---

<Layout title="Kategorien - E-Kinderauto">
	<Header />
	<NewsletterModal client:idle />
	<main class="bg-white pb-20">
		<div class="bg-gray-50 py-12 md:py-20 mb-12 border-b border-gray-100">
			<div class="container mx-auto px-6 md:px-12 text-center">
				<h1 class="text-4xl md:text-5xl font-bold mb-4 tracking-tight">Kategorien</h1>
				<p class="text-gray-500 max-w-2xl mx-auto text-lg">
					Wähle eine Kategorie und entdecke unsere Produkte.
				</p>
			</div>
		</div>

		<div class="container mx-auto px-6 md:px-12">
			<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 md:gap-8">
				{categoriesWithBackgroundImages.map((cat) => (
					<a
						href={cat.url}
						class="group relative block aspect-[4/3] rounded-xl overflow-hidden bg-gray-100"
					>
						<!-- Hintergrund: zufälliges Produktbild aus dieser Kategorie -->
						<div
							class="absolute inset-0 bg-cover bg-center transition-transform duration-500 group-hover:scale-105"
							style={`background-image: url(${cat.image});`}
							aria-hidden="true"
						/>
						<div class="absolute inset-0 bg-black/30 group-hover:bg-black/40 transition-colors" />
						<div class="absolute inset-0 flex items-end p-4 md:p-5">
							<span class="text-lg md:text-xl font-bold text-white drop-shadow-sm">
								{getCategoryDisplayName(cat.name)}
							</span>
						</div>
					</a>
				))}
			</div>
		</div>
	</main>
</Layout>
